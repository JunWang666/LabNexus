name: Auto Build
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build, Test, and Package
    # è¿è¡Œå¹³å°ï¼Œwindows-latest ç›®å‰æ˜¯ windows server 2022
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - qt_ver: 6.9.1
            qt_arch: win64_msvc2022_64
            qt_target: win64_msvc2022_64
            msvc_arch: x64

    env:
      targetName: LabNexus.exe

    # æ­¥éª¤
    steps:
      # 1. å®‰è£…Qt
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ matrix.qt_ver }}
          arch: ${{ matrix.qt_arch }}
          cache: true

      # 2. æ‹‰å–ä»£ç 
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 3. ç¼“å­˜ CMake æ„å»ºç›®å½•
      - name: Cache CMake build
        uses: actions/cache@v3
        with:
          path: build
          key: ${{ runner.os }}-build-${{ matrix.qt_ver }}-${{ matrix.qt_arch }}-${{ matrix.msvc_arch }}-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ matrix.qt_ver }}-${{ matrix.qt_arch }}-${{ matrix.msvc_arch }}-

      # 4. ä½¿ç”¨ CMake å’Œ MSVC ç¼–è¯‘
      - name: Build with MSVC (CMake)
        shell: cmd
        run: |
          rem è®¾ç½® MSVC ç¼–è¯‘ç¯å¢ƒ
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" ${{ matrix.msvc_arch }}
          rem CMake é…ç½®
          cmake -S . -B build -D CMAKE_PREFIX_PATH=%QT_ROOT_DIR%
          rem CMake ç¼–è¯‘
          cmake --build build --config Release --parallel

      # 5. è¿è¡Œå•å…ƒæµ‹è¯•
      - name: Run unit tests
        shell: cmd
        run: |
          rem åˆ‡æ¢åˆ°æ„å»ºç›®å½•å¹¶æ‰§è¡Œæµ‹è¯•
          cd build
          ctest -C Release --output-on-failure

      # 6. æ‰“åŒ…
      - name: Package
        id: package
        shell: pwsh
        env:
          archiveName: ${{ matrix.qt_ver }}-${{ matrix.qt_target }}-${{ matrix.qt_arch }}
          msvcArch: ${{ matrix.msvc_arch }}
        run: |
          if (-not (Test-Path "build/Release/${env:targetName}")) {
            Write-Warning "å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡æ‰“åŒ…æ­¥éª¤"
            exit 0
          }
          if (-not (Test-Path "scripts/windows-publish.ps1")) {
            Write-Warning "æ‰“åŒ…è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡æ‰“åŒ…æ­¥éª¤"
            exit 0
          }
          try {
            & .\scripts\windows-publish.ps1 ${env:archiveName} "build/Release/${env:targetName}"
            echo "packageSuccess=true" >> $env:GITHUB_OUTPUT
          } catch {
            Write-Warning "æ‰“åŒ…å¤±è´¥: $_"
            echo "packageSuccess=false" >> $env:GITHUB_OUTPUT
          }

      # 7. æ„å»ºçŠ¶æ€æ€»ç»“
      - name: Build Summary
        # `if: always()`ç¡®ä¿æ— è®ºå‰é¢çš„æ­¥éª¤æ˜¯å¦å¤±è´¥ï¼Œè¿™ä¸ªæ€»ç»“æ­¥éª¤éƒ½ä¼šè¿è¡Œ
        if: always()
        shell: pwsh
        run: |
          Write-Host "=== æ„å»ºçŠ¶æ€æ€»ç»“ ===" -ForegroundColor Green
          if (Test-Path "build/Release/${env:targetName}") {
            Write-Host "âœ… æ„å»ºæˆåŠŸ: ${env:targetName}" -ForegroundColor Green
          } else {
            Write-Host "âŒ æ„å»ºå¤±è´¥: æ‰¾ä¸åˆ°å¯æ‰§è¡Œæ–‡ä»¶" -ForegroundColor Red
            # å¦‚æœéœ€è¦è®©æ•´ä¸ªä»»åŠ¡åœ¨æ„å»ºå¤±è´¥æ—¶ä¹Ÿå¤±è´¥ï¼Œå¯ä»¥å–æ¶ˆä¸‹é¢è¿™è¡Œçš„æ³¨é‡Š
            # exit 1 
          }
          if ("${{ steps.package.outputs.packageSuccess }}" -eq "true") {
            Write-Host "âœ… æ‰“åŒ…æˆåŠŸ (ä½†æœªä¸Šä¼ )" -ForegroundColor Green
          } else {
            Write-Host "âš ï¸ æ‰“åŒ…å¤±è´¥æˆ–æœªæ‰§è¡Œ" -ForegroundColor Yellow
          }
          Write-Host "ğŸ‰ æ•´ä½“æµç¨‹å®Œæˆ" -ForegroundColor Green