name: Windows
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    name: Build
    # è¿è¡Œå¹³å°ï¼Œwindows-latest ç›®å‰æ˜¯ windows server 2022
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - qt_ver: 6.9.1
            qt_arch: win64_msvc2022_64
            qt_target: win64_msvc2022_64
            msvc_arch: x64

    env:
      targetName: LabNexus.exe

    # æ­¥éª¤
    steps:
      # 1. å®‰è£…Qt (å·²æ›´æ–°)
      - name: Install Qt
        # æ›´æ–°åˆ° v4ï¼Œå®ƒä¼šè‡ªåŠ¨å¤„ç† MSVC ç¯å¢ƒ
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ matrix.qt_ver }}
          arch: ${{ matrix.qt_arch }} # <-- ä½¿ç”¨ MSVC æ¶æ„

      # 2. æ‹‰å–ä»£ç  (ç‰ˆæœ¬æ›´æ–°)
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 3. ä½¿ç”¨ CMake å’Œ MSVC ç¼–è¯‘
      - name: Build with MSVC (CMake)
        id: build
        shell: cmd
        run: |
          rem è®¾ç½® MSVC ç¼–è¯‘ç¯å¢ƒï¼Œè¿™æ­¥ä»ç„¶éœ€è¦
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" ${{ matrix.msvc_arch }}

          rem 1. CMake é…ç½®æ­¥éª¤ï¼šç”Ÿæˆ Visual Studio é¡¹ç›®æ–‡ä»¶
          rem -S . æŒ‡å®šæºç åœ¨å½“å‰ç›®å½•
          rem -B build æŒ‡å®šç”Ÿæˆçš„æ–‡ä»¶æ”¾åœ¨ä¸€ä¸ªæ–°çš„ "build" ç›®å½•ä¸­
          rem -D CMAKE_PREFIX_PATH=%QT_ROOT_DIR% å‘Šè¯‰ CMake åœ¨å“ªé‡Œæ‰¾åˆ°ä½ å®‰è£…çš„ Qt
          cmake -S . -B build -D CMAKE_PREFIX_PATH=%QT_ROOT_DIR%

          rem 2. CMake ç¼–è¯‘æ­¥éª¤ï¼šä½¿ç”¨ç”Ÿæˆçš„é¡¹ç›®æ–‡ä»¶è¿›è¡Œç¼–è¯‘
          rem --config Release æŒ‡å®šç¼–è¯‘ Release ç‰ˆæœ¬
          cmake --build build --config Release

      # 4. ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload build directory
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: build

  test:
    name: Run unit tests
    needs: build
    runs-on: windows-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build
          path: build
      # 4. è¿è¡Œå•å…ƒæµ‹è¯•
      - name: Run unit tests
        id: test
        shell: cmd
        run: |
          rem åˆ‡æ¢åˆ°æ„å»ºç›®å½•å¹¶æ‰§è¡Œæµ‹è¯•
          cd build
          ctest -C Release --output-on-failure

  package:
    name: Package artifacts
    needs: build
    runs-on: windows-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build
          path: build
      # 5. æ‰“åŒ… (å¯é€‰æ­¥éª¤ï¼Œå¤±è´¥ä¸å½±å“æ•´ä½“æ„å»ºçŠ¶æ€)
      - name: package
        shell: pwsh
        env:
          archiveName: ${{ matrix.qt_ver }}-${{ matrix.qt_target }}-${{ matrix.qt_arch }}
          msvcArch: ${{ matrix.msvc_arch }}
        run: |
          # æ£€æŸ¥æ„å»ºæ˜¯å¦æˆåŠŸ
          if (-not (Test-Path "build/Release/${env:targetName}")) {
            Write-Warning "å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡æ‰“åŒ…æ­¥éª¤"
            exit 0
          }
          
          # æ£€æŸ¥è„šæœ¬æ˜¯å¦å­˜åœ¨
          if (-not (Test-Path "scripts/windows-publish.ps1")) {
            Write-Warning "æ‰“åŒ…è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡æ‰“åŒ…æ­¥éª¤"
            exit 0
          }
          
          # æ‰§è¡Œæ‰“åŒ…
          try {
            & .\scripts\windows-publish.ps1 ${env:archiveName} "build/Release/${env:targetName}"
            $name = ${env:archiveName}
            echo "packageName=$name" >> $env:GITHUB_OUTPUT
            echo "packageSuccess=true" >> $env:GITHUB_OUTPUT
          } catch {
            Write-Warning "æ‰“åŒ…å¤±è´¥: $_"
            echo "packageSuccess=false" >> $env:GITHUB_OUTPUT
          }

      # 6. ä¸Šä¼ æ„å»ºäº§ç‰© (ä»…åœ¨æ‰“åŒ…æˆåŠŸæ—¶æ‰§è¡Œ)
      - name: Upload artifacts
        if: steps.package.outputs.packageSuccess == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.packageName }}
          path: ${{ steps.package.outputs.packageName }}.zip

      # 7. æ„å»ºçŠ¶æ€æ€»ç»“
      - name: Build Summary
        shell: pwsh
        run: |
          Write-Host "=== æ„å»ºçŠ¶æ€æ€»ç»“ ===" -ForegroundColor Green
          
          # æ£€æŸ¥æ„å»ºçŠ¶æ€
          if (Test-Path "build/Release/${env:targetName}") {
            Write-Host "âœ… æ„å»ºæˆåŠŸ: ${env:targetName}" -ForegroundColor Green
          } else {
            Write-Host "âŒ æ„å»ºå¤±è´¥: æ‰¾ä¸åˆ°å¯æ‰§è¡Œæ–‡ä»¶" -ForegroundColor Red
            exit 1
          }
          
          # æ£€æŸ¥æ‰“åŒ…çŠ¶æ€
          if ("${{ steps.package.outputs.packageSuccess }}" -eq "true") {
            Write-Host "âœ… æ‰“åŒ…æˆåŠŸ" -ForegroundColor Green
          } elseif ("${{ steps.package.conclusion }}" -eq "skipped") {
            Write-Host "â­ï¸ æ‰“åŒ…æ­¥éª¤è¢«è·³è¿‡" -ForegroundColor Yellow
          } else {
            Write-Host "âš ï¸ æ‰“åŒ…å¤±è´¥æˆ–æœªæ‰§è¡Œ" -ForegroundColor Yellow
          }
          
          Write-Host "ğŸ‰ æ•´ä½“æ„å»ºæµç¨‹å®Œæˆ" -ForegroundColor Green
